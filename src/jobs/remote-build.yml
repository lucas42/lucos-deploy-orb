parameters:
  build-domain:
    type: string
  ssh-port:
    type: integer
  architecture:
    type: string
environment:
  BUILD_DOMAIN: << parameters.build-domain >>
  SSH_PORT: << parameters.ssh-port >>
  ARCH: << parameters.architecture >>
docker:
  - image: circleci/buildpack-deps:buster
steps:
  - run:
      name: Check BUILD_DOMAIN
      command: echo "Building on host \"$BUILD_DOMAIN\""
  - add_ssh_keys:
      fingerprints:
        - "3b:d2:84:bc:c8:2e:09:b7:2f:e7:50:23:46:41:cf:23"
  - run:
      name: Populate known_hosts
      command: ssh-keyscan -p $SSH_PORT -H $BUILD_DOMAIN >> ~/.ssh/known_hosts
  - run:
      name: Remote build
      command: ssh $DEPLOY_USERNAME@$BUILD_DOMAIN -o "StrictHostKeyChecking no" -A -p $SSH_PORT CIRCLE_REPOSITORY_URL=$CIRCLE_REPOSITORY_URL DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME DOCKERHUB_PASSWORD=$DOCKERHUB_PASSWORD ARCH=$ARCH quickbuild.sh
